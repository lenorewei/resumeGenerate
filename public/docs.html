<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="UTF-8">
  <title>NanoGen</title>
  <meta name="description" content="Micro Static Site Generator in Node.js"/>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#157878">
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" href="/assets/style.css">
</head>
<body>
<section class="page-header">
  <h1 class="project-name">NanoGen</h1>
  <h2 class="project-tagline">Micro Static Site Generator in Node.js</h2>
  <a href="/" class="btn">Home</a>
  <a href="/docs" class="btn">Docs</a>
  <a href="https://github.com/doug2k1/nanogen" class="btn">GitHub</a>
</section>
<section class="main-content">
  
  <h1 id="react-native-webview-">React Native 内的webview重新封装并添加图片上传</h1>
<p>Rn中的webview相比与原生的安卓的webview，有许多原生很容易实现的功能没有接入，但当我们需要使用到那些功能，例如去添加网页的加载进度百分比，添加对网页中type为file的input的支持等，rn中并没有与这些相关的api支持我们去做这些，当这样的时候，最好的方式就是在rn的代码基础上，重新去封装一个webview，利用原生的api去实现一个功能。</p>
<h2 id="-webview">如何去封装一个webview</h2>
<ol>
<li><p>拷贝reactnative内部的webview（ReactWebViewManager.class，WebViewConfig.class）实现代码到安卓目录下</p>
<p><img src="https://lenore-1254182071.cossh.myqcloud.com/blog/2018-06-13-072824.png" alt=""></p>
<ol start="2">
<li>拷贝（<em>node</em>modules_react-native_Libraries_Components_WebView_WebView.android.js）到自己的文件夹中并修改<pre><code class="language-java">protected static final String REACT_CLASS = &quot;RCTWebView&quot;;</code></pre>
为<pre><code class="language-java">protected static final String REACT_CLASS = &quot;RCTWebView1&quot;;</code></pre>
</li>
</ol>
</li>
<li><p>新建<code>ReactWebViewPackage.java</code>添加<code>ReactWebViewManager</code>
<code>`</code>java
 import com.facebook.react.ReactPackage;
 import com.facebook.react.bridge.NativeModule;
 import com.facebook.react.bridge.ReactApplicationContext;
 import com.facebook.react.uimanager.ViewManager;</p>
<p> import java.util.Arrays;
 import java.util.Collections;
 import java.util.List;</p>
<p> public class ReactWebViewPackage implements ReactPackage {</p>
</li>
</ol>
<pre><code>    @Override
    public List&lt;NativeModule&gt; createNativeModules(ReactApplicationContext reactContext) {

        return Collections.emptyList();
    }

    @Override
    public List&lt;ViewManager&gt; createViewManagers(ReactApplicationContext reactContext) {
        return Arrays.&lt;ViewManager&gt;asList(new ReactWebViewManager());
    }

}</code></pre><pre><code>4. 在MainApplication.java中添加引用
```java
    @Override
        protected List&lt;ReactPackage&gt; getPackages() {
          return Arrays.&lt;ReactPackage&gt;asList(
                  new MainReactPackage(),
                  new ReactWebViewPackage(),
          );
        }</code></pre><p>这样就能在封好的webview中即<code>ReactWebViewPackage.java</code>中添加原生方法了。</p>
<h2 id="-">如何添加图片的上传。</h2>
<p>Rn的webview很坑爹的并不支持input类型为file，就是当遇到内嵌页面中有图片上传的需求的时候，就必须我们额外去添加上这一支持。
以下显示的是针对原生的rnwebview的封装，而不是针对我们上面自己封装的。</p>
<ol>
<li><p>添加<code>AdvancedWebView.java</code>,对webview多封装一层</p>
<pre><code class="language-java">public class AdvancedWebviewManager extends ReactWebViewManager {

 private ValueCallback mUploadMessage;
 private final static int FCR=1;

 public WebView webview = null;

 private AdvancedWebviewPackage aPackage;
 public String getName() {

     return &quot;AdvancedWebView&quot;;
 }

 @ReactProp(name = &quot;enabledUploadAndroid&quot;)
 public void enabledUploadAndroid(WebView view, boolean enabled) {
     if(enabled) {
         webview = view;
         final AdvancedWebviewModule module = this.aPackage.getModule();
         view.setWebChromeClient(new WebChromeClient(){

             //For Android 3.0+
             public void openFileChooser(ValueCallback uploadMsg){
                 module.setUploadMessage(uploadMsg);
                 mUploadMessage = uploadMsg;
                 Intent i = new Intent(Intent.ACTION_GET_CONTENT);
                 i.addCategory(Intent.CATEGORY_OPENABLE);
                 i.setType(&quot;*/*&quot;);
                 module.getActivity().startActivityForResult(Intent.createChooser(i, &quot;File Chooser&quot;), FCR);
             }
             // For Android 3.0+, above method not supported in some android 3+ versions, in such case we use this
             public void openFileChooser(ValueCallback uploadMsg, String acceptType){
                 module.setUploadMessage(uploadMsg);
                 mUploadMessage = uploadMsg;
                 Intent i = new Intent(Intent.ACTION_GET_CONTENT);
                 i.addCategory(Intent.CATEGORY_OPENABLE);
                 i.setType(&quot;*/*&quot;);
                 module.getActivity().startActivityForResult(
                         Intent.createChooser(i, &quot;File Browser&quot;),
                         FCR);
             }
             //For Android 4.1+
             public void openFileChooser(ValueCallback uploadMsg, String acceptType, String capture){
                 module.setUploadMessage(uploadMsg);
                 mUploadMessage = uploadMsg;
                 Intent i = new Intent(Intent.ACTION_GET_CONTENT);
                 i.addCategory(Intent.CATEGORY_OPENABLE);
                 i.setType(&quot;*/*&quot;);
                 module.getActivity().startActivityForResult(Intent.createChooser(i, &quot;File Chooser&quot;), FCR);
             }
             //For Android 5.0+
             public boolean onShowFileChooser(
                     WebView webView, ValueCallback&lt;Uri[]&gt; filePathCallback,
                     WebChromeClient.FileChooserParams fileChooserParams) {
                 module.setmUploadCallbackAboveL(filePathCallback);
                 /*if(mUMA != null){
                     mUMA.onReceiveValue(null);
                 }*/
                 if (module.grantPermissions()) {
                     module.uploadImage(filePathCallback);
                 }
                 return true;
             }
         });

     }
 }

 public void setPackage(AdvancedWebviewPackage aPackage){
     this.aPackage = aPackage;
 }

 public AdvancedWebviewPackage getPackage(){
     return this.aPackage;
 }
}</code></pre>
</li>
<li><p>添加<code>AdvancedWebviewPackage.java</code></p>
<pre><code class="language-java">public class AdvancedWebviewPackage implements ReactPackage {
 private AdvancedWebviewManager manager;
 private AdvancedWebviewModule module;

 public List&lt;Class&lt;? extends JavaScriptModule&gt;&gt; createJSModules() {
     return Collections.emptyList();
 }

 @Override public List createViewManagers(ReactApplicationContext reactContext) {
     manager = new AdvancedWebviewManager();
     manager.setPackage(this);
     return Arrays.&lt;ViewManager&gt;asList(manager);
 }

 @Override public List createNativeModules( ReactApplicationContext reactContext) {
     List modules = new ArrayList&lt;&gt;();
     module = new AdvancedWebviewModule(reactContext);
     module.setPackage(this);
     modules.add(module);
     return modules;
 }

 public AdvancedWebviewManager getManager(){
     return manager;
 }

 public AdvancedWebviewModule getModule(){
     return module;
 }
}</code></pre>
</li>
<li><p>在MainApplication.java中添加引用</p>
<pre><code class="language-java"> @Override
     protected List&lt;ReactPackage&gt; getPackages() {
       return Arrays.&lt;ReactPackage&gt;asList(
               new MainReactPackage(),
               new AdvancedWebviewPackage(),
       );
     }</code></pre>
</li>
<li><p>在<code>WebView.android.js</code>中添加新的prop属性支持</p>
<pre><code class="language-js">enabledUploadAndroid: PropTypes.bool,
...
enabledUploadAndroid={this.props.enabledUploadAndroid}</code></pre>
<p>#blog/2018-07-01</p>
</li>
</ol>


  <footer class="site-footer">
    <span class="site-footer-owner"><a href="https://github.com/pages-themes/cayman">cayman</a> is maintained by <a href="https://github.com/pages-themes">pages-themes</a>.</span>
    <span class="site-footer-credits">This page was generated by <a href="https://github.com/doug2k1/nanogen">Nanogen</a>.</span>
  </footer>
</section>
</body>
</html>